<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dura Bulk Detector</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: #0f1117;
    color: #e0e0e0;
    min-height: 100vh;
    padding: 2rem;
  }
  h1 {
    text-align: center;
    font-size: 2rem;
    margin-bottom: 0.5rem;
    color: #fff;
  }
  .subtitle {
    text-align: center;
    color: #888;
    margin-bottom: 2rem;
  }
  .card {
    background: #1a1d27;
    border-radius: 12px;
    padding: 1.5rem;
    max-width: 700px;
    margin: 0 auto 2rem;
    border: 1px solid #2a2d37;
  }
  label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.3rem;
    color: #ccc;
  }
  input[type="text"], input[type="date"], input[type="number"] {
    width: 100%;
    padding: 0.6rem 0.8rem;
    border: 1px solid #3a3d47;
    border-radius: 8px;
    background: #0f1117;
    color: #e0e0e0;
    font-size: 1rem;
    margin-bottom: 1rem;
  }
  input:focus { outline: none; border-color: #4a90d9; }
  .date-row { display: flex; gap: 1rem; }
  .date-row > div { flex: 1; }
  button {
    width: 100%;
    padding: 0.8rem;
    border: none;
    border-radius: 8px;
    background: #4a90d9;
    color: #fff;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
  }
  button:hover { background: #3a7bc8; }
  button:disabled { background: #333; cursor: not-allowed; }

  /* Progress */
  #progress-section { display: none; }
  .progress-bar-outer {
    width: 100%;
    height: 8px;
    background: #2a2d37;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 0.8rem;
  }
  .progress-bar-inner {
    height: 100%;
    background: #4a90d9;
    border-radius: 4px;
    transition: width 0.3s;
    width: 0%;
  }
  #status-text { color: #aaa; font-size: 0.9rem; }

  /* Results */
  #results-section { display: none; max-width: 1200px; margin: 0 auto; }
  .results-header {
    text-align: center;
    font-size: 1.3rem;
    margin-bottom: 1rem;
    color: #fff;
  }
  .columns { display: flex; gap: 2rem; }
  .column { flex: 1; }
  .column h3 {
    margin-bottom: 0.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #2a2d37;
  }
  .column h3.dura { border-color: #4caf50; color: #4caf50; }
  .column h3.non-dura { border-color: #f44336; color: #f44336; }
  .gallery {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 0.5rem;
    margin-bottom: 1rem;
  }
  .gallery img {
    width: 100%;
    aspect-ratio: 1;
    object-fit: cover;
    border-radius: 6px;
    cursor: pointer;
    transition: transform 0.15s;
  }
  .gallery img:hover { transform: scale(1.05); }
  .dl-btn {
    display: inline-block;
    width: auto;
    padding: 0.5rem 1.2rem;
    font-size: 0.85rem;
    background: #2a2d37;
    border-radius: 6px;
    text-decoration: none;
    color: #e0e0e0;
    border: 1px solid #3a3d47;
    cursor: pointer;
    transition: background 0.2s;
  }
  .dl-btn:hover { background: #3a3d47; }
  .empty-msg { color: #666; font-style: italic; padding: 1rem 0; }

  /* Lightbox */
  .lightbox {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.9);
    z-index: 100;
    justify-content: center;
    align-items: center;
    cursor: pointer;
  }
  .lightbox.active { display: flex; }
  .lightbox img {
    max-width: 90%;
    max-height: 90%;
    border-radius: 8px;
  }
</style>
</head>
<body>

<h1>Dura Bulk Detector</h1>
<p class="subtitle">Scrape Instagram profile images, detect boats, find "Dura Bulk" text</p>

<div class="card">
  <form id="scrape-form">
    <label for="profile">Instagram Profile</label>
    <input type="text" id="profile" placeholder="e.g. durabulk (no @ needed)" required>

    <div class="date-row">
      <div>
        <label for="start_date">Start Date</label>
        <input type="date" id="start_date" required>
      </div>
      <div>
        <label for="end_date">End Date</label>
        <input type="date" id="end_date" required>
      </div>
    </div>

    <label for="max_posts">Max Posts</label>
    <input type="number" id="max_posts" value="100" min="1" max="500">

    <button type="submit" id="start-btn">Start Detection</button>
  </form>
</div>

<div class="card" id="progress-section">
  <div class="progress-bar-outer">
    <div class="progress-bar-inner" id="progress-bar"></div>
  </div>
  <div id="status-text">Starting...</div>
</div>

<div id="results-section">
  <p class="results-header" id="results-summary"></p>
  <div class="columns">
    <div class="column">
      <h3 class="dura">Dura Bulk (<span id="dura-count">0</span>)</h3>
      <div class="gallery" id="dura-gallery"></div>
      <a class="dl-btn" id="dl-dura" href="/api/download/dura_bulk" style="display:none;">Download ZIP</a>
    </div>
    <div class="column">
      <h3 class="non-dura">Non-Dura Bulk (<span id="non-dura-count">0</span>)</h3>
      <div class="gallery" id="non-dura-gallery"></div>
      <a class="dl-btn" id="dl-non-dura" href="/api/download/non_dura_bulk" style="display:none;">Download ZIP</a>
    </div>
  </div>
</div>

<div class="lightbox" id="lightbox" onclick="this.classList.remove('active')">
  <img id="lightbox-img" src="" alt="Full size">
</div>

<script>
const form = document.getElementById("scrape-form");
const startBtn = document.getElementById("start-btn");
const progressSection = document.getElementById("progress-section");
const progressBar = document.getElementById("progress-bar");
const statusText = document.getElementById("status-text");
const resultsSection = document.getElementById("results-section");
const resultsSummary = document.getElementById("results-summary");
const duraGallery = document.getElementById("dura-gallery");
const nonDuraGallery = document.getElementById("non-dura-gallery");
const duraCount = document.getElementById("dura-count");
const nonDuraCount = document.getElementById("non-dura-count");
const dlDura = document.getElementById("dl-dura");
const dlNonDura = document.getElementById("dl-non-dura");
const lightbox = document.getElementById("lightbox");
const lightboxImg = document.getElementById("lightbox-img");

let pollTimer = null;

form.addEventListener("submit", async (e) => {
  e.preventDefault();
  const profile = document.getElementById("profile").value.trim();
  const startDate = document.getElementById("start_date").value;
  const endDate = document.getElementById("end_date").value;
  const maxPosts = document.getElementById("max_posts").value;

  if (!profile || !startDate || !endDate) return;

  startBtn.disabled = true;
  startBtn.textContent = "Running...";
  progressSection.style.display = "block";
  resultsSection.style.display = "none";
  progressBar.style.width = "0%";
  statusText.textContent = "Starting...";

  try {
    const res = await fetch("/api/scrape", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ profile, start_date: startDate, end_date: endDate, max_posts: maxPosts }),
    });
    const data = await res.json();
    if (data.error) {
      statusText.textContent = "Error: " + data.error;
      startBtn.disabled = false;
      startBtn.textContent = "Start Detection";
      return;
    }
    pollStatus(data.job_id);
  } catch (err) {
    statusText.textContent = "Request failed: " + err.message;
    startBtn.disabled = false;
    startBtn.textContent = "Start Detection";
  }
});

function pollStatus(jobId) {
  if (pollTimer) clearInterval(pollTimer);
  pollTimer = setInterval(async () => {
    try {
      const res = await fetch(`/api/status/${jobId}`);
      const job = await res.json();

      statusText.textContent = job.detail || job.step;

      if (job.total > 0 && job.current > 0) {
        const pct = Math.round((job.current / job.total) * 100);
        progressBar.style.width = pct + "%";
      } else if (job.step === "scraping") {
        progressBar.style.width = "30%";
      }

      if (job.step === "done") {
        clearInterval(pollTimer);
        progressBar.style.width = "100%";
        startBtn.disabled = false;
        startBtn.textContent = "Start Detection";
        showResults(job.results);
      } else if (job.step === "error") {
        clearInterval(pollTimer);
        startBtn.disabled = false;
        startBtn.textContent = "Start Detection";
      }
    } catch (err) {
      // keep polling
    }
  }, 1500);
}

function showResults(results) {
  resultsSection.style.display = "block";
  duraGallery.innerHTML = "";
  nonDuraGallery.innerHTML = "";

  const dura = results.dura_bulk || [];
  const nonDura = results.non_dura_bulk || [];

  duraCount.textContent = dura.length;
  nonDuraCount.textContent = nonDura.length;
  resultsSummary.textContent =
    `Found ${dura.length + nonDura.length} images: ${dura.length} with "Dura Bulk", ${nonDura.length} without.`;

  dura.forEach((name) => {
    const img = document.createElement("img");
    img.src = `/api/images/dura_bulk/${encodeURIComponent(name)}`;
    img.alt = name;
    img.onclick = () => openLightbox(img.src);
    duraGallery.appendChild(img);
  });

  nonDura.forEach((name) => {
    const img = document.createElement("img");
    img.src = `/api/images/non_dura_bulk/${encodeURIComponent(name)}`;
    img.alt = name;
    img.onclick = () => openLightbox(img.src);
    nonDuraGallery.appendChild(img);
  });

  if (dura.length === 0) duraGallery.innerHTML = '<p class="empty-msg">No matches found.</p>';
  if (nonDura.length === 0) nonDuraGallery.innerHTML = '<p class="empty-msg">No images.</p>';

  dlDura.style.display = dura.length > 0 ? "inline-block" : "none";
  dlNonDura.style.display = nonDura.length > 0 ? "inline-block" : "none";
}

function openLightbox(src) {
  lightboxImg.src = src;
  lightbox.classList.add("active");
}
</script>

</body>
</html>
